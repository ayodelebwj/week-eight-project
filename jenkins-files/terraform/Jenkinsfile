pipeline {
    agent any

    environment {
        AWS_ACCESS_KEY_ID = credentials ('aws-access-key-id')
        AWS_SECRET_ACCESS_KEY = credentials ('aws-secret-access-key')
        AWS_DEFAULT_REGION = 'us-east-2'
    }

    parameters {

        choice (
            name: 'TF_ACTION',
            choices: ['PLAN', 'APPLY', 'DESTROY'],
            description: 'Choose Action To Perform'
        )
    }

    stages {
        // This stage applies the terraform plan command to see 
        // changes to be made to the infrstructure 
        stage ('Terraform Plan') {
        when {
            expression {params.TF_ACTION == 'PLAN'}
        }    
            steps {
                dir ('terraform-infrastructure') {
                sh 'terraform init'
                sh 'terraform fmt'
                sh 'terraform validate'
                sh 'terraform plan -var-file="dev.tfvars"'
                }
            }
        }

        // This stage applies the terraform apply command to the 
        // configuration file to build the infrastructure
        stage ('Terraform Apply') {
        when {
            expression {params.TF_ACTION == 'APPLY'}
        }    
            steps {
                dir ('terraform-infrastructure') {
                sh 'terraform init'
                sh 'terraform fmt'
                sh 'terraform validate'
                sh 'terraform apply -var-file="dev.tfvars" --auto-approve'
                }
            }
        }

        // This stage applies the terraform destroy command to the 
        // configuration file to destroy the built infrastructure
        stage ('Terraform Destroy') {
        when {
            expression {params.TF_ACTION == 'DESTROY'}
        }    
            steps {
                dir ('terraform-infrastructure') {
                sh 'terraform init'
                sh 'terraform fmt'
                sh 'terraform validate'
                sh 'terraform destroy --auto-approve'
                }
            }
        }
    }

    post {
        success {
            echo 'Infrastructure built successfully'
        }
        failure {
            echo 'Infrastructure building failed'
        }
    }
}